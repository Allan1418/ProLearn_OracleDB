/*CAPITULO_HIJO*/


-- Se creo la vista de los capitulo hijos que estan en estado 1
CREATE OR REPLACE VIEW FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_HIJO_V AS
 SELECT 
  CAPITULO_HIJO_TB_ID_CH_PK,
  ID_CAPITULO_PADRE,
  NOMBRE_CAPITULO_HIJO ,
  VIDEO_CAPITULO ,
  NUMERO_CAPITULO_HIJO
  FROM FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_HIJO_TB
  WHERE ESTADO_DELET_HIJO = 1;
/


--- Buscar ID Capitulo Hijo 

CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.CAPITULO_HIJO_GET_BYID_SP (
    P_ID_CAPITULO_HIJO IN NUMBER,
    P_RESULTADO OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN P_RESULTADO FOR
        SELECT * FROM FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_HIJO_V CH
        WHERE CH.CAPITULO_HIJO_TB_ID_CH_PK = P_ID_CAPITULO_HIJO;
END;    
/


---Se  busca el ID del Capitulo Padre y del Curso relacionado al Capitulo Hijo

CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.CAPITULO_HIJO_GETALL_BYID_CP_X_CAP_SP(
  P_ID_CURSO IN NUMBER,
  P_ID_CAPITULO_PADRE IN NUMBER,
  P_RESULTADO OUT SYS_REFCURSOR
) IS
BEGIN
  OPEN P_RESULTADO FOR
    SELECT CH.* FROM FIDE_CAPITULO_HIJO_V CH
    JOIN FIDE_CAPITULO_X_CURSO_TB CC ON CH.CAPITULO_HIJO_TB_ID_CH_PK = CC.ID_CAPITULO
    WHERE CC.ID_CURSO = P_ID_CURSO
    AND CH.ID_CAPITULO_PADRE = P_ID_CAPITULO_PADRE
    ORDER BY CH.NUMERO_CAPITULO_HIJO;
END;
/


-- Procedimiento para eliminar el estado de capitulo hijo

CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.CAPITULO_HIJO_DELET_SP(
  P_ID_HIJO IN NUMBER
) AS
BEGIN
  UPDATE FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_HIJO_TB
  SET ESTADO_DELET_HIJO = 0
  WHERE CAPITULO_HIJO_TB_ID_CH_PK = P_ID_HIJO;
  COMMIT;
END;
/


-- Este procedimiento tiene un parametro adicional P_ID_HIJO que indica si se debe crear un nuevo capatulo hijo 
-- (si es 0) o actualizar uno existente (si es un valor diferente de 0).

CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.CAPITULO_HIJO_UPSERT_SP(
  P_ID_HIJO IN NUMBER,
  P_ID_CAPITULO_PADRE IN FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_HIJO_TB.ID_CAPITULO_PADRE%TYPE,
  P_NOMBRE_CAPITULO IN VARCHAR2,
  P_NUMERO_CAPITULO IN INT,
  P_VIDEO_CAPITULO IN VARCHAR2,
  P_ID_CURSO IN NUMBER,
  P_ID_RESULTADO OUT NUMBER
) AS

BEGIN
  IF P_ID_HIJO = 0 THEN
    INSERT INTO FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_HIJO_TB (
      ID_CAPITULO_PADRE,
      NOMBRE_CAPITULO_HIJO,
      NUMERO_CAPITULO_HIJO,
      VIDEO_CAPITULO
    ) VALUES (
      P_ID_CAPITULO_PADRE,
      P_NOMBRE_CAPITULO,
      P_NUMERO_CAPITULO,
      P_VIDEO_CAPITULO
    ) RETURNING CAPITULO_HIJO_TB_ID_CH_PK INTO P_ID_RESULTADO;
    
    
    INSERT INTO FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_X_CURSO_TB(
      ID_CURSO,
      ID_CAPITULO
    )
    VALUES(
    P_ID_CURSO,
    P_ID_RESULTADO
    );
    
    
  ELSE
    UPDATE FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_HIJO_TB
    SET NOMBRE_CAPITULO_HIJO = P_NOMBRE_CAPITULO,
        NUMERO_CAPITULO_HIJO = P_NUMERO_CAPITULO,
        VIDEO_CAPITULO = P_VIDEO_CAPITULO
    WHERE CAPITULO_HIJO_TB_ID_CH_PK = P_ID_HIJO;
    
    P_ID_RESULTADO := P_ID_HIJO;
    
  END IF;
  COMMIT;
EXCEPTION
  WHEN OTHERS THEN
    ROLLBACK;
    COMMIT;
END;
/
