CREATE TABLE FIDE_PROLEARN_FINAL_PROF.TESTI (
  PARA VARCHAR2(2)
);

/*CAPITULO_HIJO*/


--- Buscar ID Capitulo Hijo 

CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.CH_FINDBYID_SP (
    P_ID_CAPITULO_HIJO IN NUMBER,
    P_RESULTADO OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN P_RESULTADO FOR
        SELECT * FROM FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_HIJO_TB CH
        WHERE CH.CAPITULO_HIJO_TB_ID_CH_PK = P_ID_CAPITULO_HIJO;

    INSERT INTO FIDE_PROLEARN_FINAL_PROF.TESTI (PARA) VALUES ('A');
    COMMIT; 

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        OPEN P_RESULTADO FOR SELECT NULL FROM DUAL WHERE 1=0; 
END;    
/




-- Procedimiento para guardar un hijo

CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.CH_SAVE_SP(
  P_ID_CAPITULO_PADRE IN FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_HIJO_TB.ID_CAPITULO_PADRE%TYPE,
  P_NOMBRE_CAPITULO IN VARCHAR2,
  P_NUMERO_CAPITULO IN INT
) AS
BEGIN
  INSERT INTO FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_HIJO_TB (
  ID_CAPITULO_PADRE,
  NOMBRE_CAPITULO_HIJO,
  NUMERO_CAPITULO_HIJO)
  VALUES (P_ID_CAPITULO_PADRE, P_NOMBRE_CAPITULO, P_NUMERO_CAPITULO);
  COMMIT;
END;
/


-- Procedimiento para eliminar un capitulo hijo

CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.CH_DELETE_SP(
  P_ID_CAPITULO_HIJO IN FIDE_CAPITULO_HIJO_TB.CAPITULO_HIJO_TB_ID_CH_PK%TYPE
) AS
BEGIN

  DELETE FROM FIDE_CAPITULO_HIJO_TB
  WHERE CAPITULO_HIJO_TB_ID_CH_PK = P_ID_CAPITULO_HIJO;
  
  COMMIT;
END;
/


-- Procedimiento para llamar a todos los capitulos hijos

CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.CH_FIND_ID_SP AS
  CURSOR CUR_CAPITULOS_HIJOS IS
    SELECT *
    FROM FIDE_CAPITULO_HIJO_TB;
  
  V_REGISTRO FIDE_CAPITULO_HIJO_TB%ROWTYPE;
BEGIN
  OPEN CUR_CAPITULOS_HIJOS;
  
  DBMS_OUTPUT.PUT_LINE('ID padre');
  
  LOOP
    FETCH CUR_CAPITULOS_HIJOS INTO V_REGISTRO;
    EXIT WHEN CUR_CAPITULOS_HIJOS%NOTFOUND;
    
    DBMS_OUTPUT.PUT_LINE( V_REGISTRO.ID_CAPITULO_PADRE );
  END LOOP;
  
  CLOSE CUR_CAPITULOS_HIJOS;
END CH_FIND_ID_SP;
/

BEGIN
  FIDE_PROLEARN_FINAL_PROF.CH_FIND_ID_SP;
END;
/


---Se  busca el ID del Capitulo Padre y del Curso relacionado al Capitulo Hijo

CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.GET_CAPITULOS_HIJOS_SP(
  P_ID_CURSO IN NUMBER,
  P_ID_CAPITULO_PADRE IN NUMBER,
  P_RESULTADO OUT SYS_REFCURSOR
) IS
BEGIN
  OPEN P_RESULTADO FOR
    SELECT CH.*
    FROM FIDE_CAPITULO_HIJO_TB CH
    JOIN FIDE_CAPITULO_X_CURSO_TB CC ON CH.CAPITULO_HIJO_TB_ID_CH_PK = CC.ID_CAPITULO
    WHERE CC.ID_CURSO = P_ID_CURSO
    AND CH.ID_CAPITULO_PADRE = P_ID_CAPITULO_PADRE
    ORDER BY CH.NUMERO_CAPITULO_HIJO;
END;
/



