 CREATE TABLE FIDE_PROLEARN_FINAL_PROF.TESTI (
  PARA VARCHAR2(2)
);



/*CAPITULO_PADRE*/


--- Procedimiento para buscar al Capitulo Padre mediante el id
CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.CP_FINDBYID_SP (
  P_ID_CAPITULO_PADRE IN NUMBER,
  P_RESULTADO OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN P_RESULTADO FOR
        SELECT 
            CAPITULO_PADRE_TB_ID_CP_PK,
            NOMBRE_CAPITULO_PADRE,
            NUMERO_CAPITULO_PADRE,
            ESTADO_PADRE_TB
        FROM FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_PADRE_TB
        WHERE CAPITULO_PADRE_TB_ID_CP_PK = P_ID_CAPITULO_PADRE
        AND ESTADO_PADRE_TB = 1;

        INSERT INTO FIDE_PROLEARN_FINAL_PROF.TESTI (PARA) VALUES ('B');
        COMMIT; 

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        OPEN P_RESULTADO FOR SELECT NULL FROM DUAL WHERE 1=0;
END;
/


---Se busca el ID del Curso y el Padre relacionado al Curso

CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.GET_CAP_PADRE_X_CURSO_SP(
  P_ID_CURSO IN NUMBER,
  P_CAPITULOS_PADRES OUT SYS_REFCURSOR
)
AS
BEGIN
  OPEN P_CAPITULOS_PADRES FOR
    SELECT DISTINCT 
        CP.CAPITULO_PADRE_TB_ID_CP_PK,
        CP.NOMBRE_CAPITULO_PADRE,
        CP.NUMERO_CAPITULO_PADRE,
        CP.ESTADO_PADRE_TB
    FROM FIDE_CAPITULO_PADRE_TB CP
    JOIN FIDE_CAPITULO_HIJO_TB CH ON CP.CAPITULO_PADRE_TB_ID_CP_PK = CH.ID_CAPITULO_PADRE
    JOIN FIDE_CAPITULO_X_CURSO_TB CC ON CH.CAPITULO_HIJO_TB_ID_CH_PK = CC.ID_CAPITULO
    WHERE CC.ID_CURSO = P_ID_CURSO
    ORDER BY CP.NUMERO_CAPITULO_PADRE;
END;
/



-- Procedimiento para actualizar el capitulo padre

CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.CP_UPDATE_ESTADO_SP(
  P_ID_CAPITULO_PADRE NUMBER,
  P_ESTADO_PADRE NUMBER
) AS
BEGIN

  UPDATE FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_PADRE_TB 
  SET ESTADO_PADRE_TB = P_ESTADO_PADRE
  WHERE CAPITULO_PADRE_TB_ID_CP_PK = P_ID_CAPITULO_PADRE;
  
  COMMIT;
END;
/


-- Procedimiento para actualizar la informacion de un capitulo padre


CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.CP_UPDATE_SP(
  P_ID_CAPITULO_PADRE NUMBER,
  P_NOMBRE_CAPITULO_PADRE VARCHAR2,
  P_NUMERO_CAPITULO_PADRE INT,
  P_ESTADO_PADRE_TB NUMBER
) AS
BEGIN

  UPDATE FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_PADRE_TB 
  SET NOMBRE_CAPITULO_PADRE = P_NOMBRE_CAPITULO_PADRE,
      NUMERO_CAPITULO_PADRE = P_NUMERO_CAPITULO_PADRE,
      ESTADO_PADRE_TB = P_ESTADO_PADRE_TB
  WHERE CAPITULO_PADRE_TB_ID_CP_PK = P_ID_CAPITULO_PADRE;
  
  COMMIT;
END;
/



-- Crear procedimiento para guardar un Capitulo padre

CREATE OR REPLACE PROCEDURE FIDE_PROLEARN_FINAL_PROF.CP_SAVE_SP(
  P_NOMBRE_CAPITULO VARCHAR2,
  P_NUMERO_CAPITULO INT
) AS
  V_ID_CAPITULO_PADRE NUMBER;
BEGIN
  INSERT INTO FIDE_PROLEARN_FINAL_PROF.FIDE_CAPITULO_PADRE_TB (
    NOMBRE_CAPITULO_PADRE,
    NUMERO_CAPITULO_PADRE
  ) VALUES (
    P_NOMBRE_CAPITULO,
    P_NUMERO_CAPITULO
  ) RETURNING CAPITULO_PADRE_TB_ID_CP_PK INTO V_ID_CAPITULO_PADRE;
  
  COMMIT;
END;
/

